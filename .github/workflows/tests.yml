name: Automated Testing

on:
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
  push:
    paths:
      - '**.py'
      - 'tests/**'
      - 'requirements.txt'

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-xdist pytest-timeout pytest-mock

    - name: Run unit tests
      run: |
        pytest tests/unit/ \
          --cov=. \
          --cov-report=xml \
          --cov-report=term \
          -v \
          -n auto \
          --timeout=300
      env:
        PYTHONPATH: ${{ github.workspace }}

    - name: Generate coverage badge
      if: matrix.python-version == '3.11'
      run: |
        pip install coverage-badge
        coverage-badge -o coverage.svg -f

    - name: Upload coverage report
      if: matrix.python-version == '3.11'
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: |
          coverage.xml
          htmlcov/
          coverage.svg

  integration-tests:
    name: Integration Tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-timeout pytest-cov pytest-mock

    - name: Create test environment
      run: |
        python -c "from pathlib import Path; Path('test_output').mkdir(exist_ok=True)"

    - name: Run integration tests
      run: |
        pytest tests/integration/ -v --timeout=600
      timeout-minutes: 15

  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-benchmark memory_profiler

    - name: Run performance benchmarks
      run: |
        pytest tests/performance/ -v --benchmark-only
      continue-on-error: true

    - name: Memory profiling
      run: |
        python -m memory_profiler tests/performance/test_memory.py
      continue-on-error: true

  mobile-build-test:
    name: Test Mobile Build Configuration
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Buildozer dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-pip \
          build-essential \
          git \
          ffmpeg \
          libsdl2-dev \
          libsdl2-image-dev \
          libsdl2-mixer-dev \
          libsdl2-ttf-dev \
          libportmidi-dev \
          libswscale-dev \
          libavformat-dev \
          libavcodec-dev \
          zlib1g-dev \
          openjdk-17-jdk

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install buildozer cython

    - name: Validate buildozer.spec
      run: |
        buildozer -v android debug || echo "Full build skipped in CI"
      continue-on-error: true
      timeout-minutes: 5

    - name: Test mobile imports
      run: |
        python test_mobile.py
      continue-on-error: true

  compatibility-tests:
    name: Compatibility Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-timeout pytest-mock

    - name: Test Pillow compatibility
      run: |
        pytest tests/compatibility/test_pillow.py -v

    - name: Test OpenCV compatibility
      run: |
        pytest tests/compatibility/test_opencv.py -v

    - name: Test file format support
      run: |
        pytest tests/compatibility/test_formats.py -v

  test-report:
    name: Generate Test Report
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, performance-tests, mobile-build-test, compatibility-tests]
    if: always()

    steps:
    - name: Download coverage report
      uses: actions/download-artifact@v4
      with:
        name: coverage-report
      continue-on-error: true

    - name: Generate summary
      run: |
        echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- Unit Tests: ${{ needs.unit-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Integration Tests: ${{ needs.integration-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Performance Tests: ${{ needs.performance-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Mobile Build Test: ${{ needs.mobile-build-test.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Compatibility Tests: ${{ needs.compatibility-tests.result }}" >> $GITHUB_STEP_SUMMARY

    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const message = `## ðŸ§ª Test Results

          - Unit Tests: ${{ needs.unit-tests.result }}
          - Integration Tests: ${{ needs.integration-tests.result }}
          - Performance Tests: ${{ needs.performance-tests.result }}
          - Mobile Build: ${{ needs.mobile-build-test.result }}
          - Compatibility: ${{ needs.compatibility-tests.result }}

          See the full test report in the Actions tab.`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: message
          });
